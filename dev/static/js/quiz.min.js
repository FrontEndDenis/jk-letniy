"use strict";

$(document).ready(function () {
  var totaDiscount = 100000;
  var asideDescLast = '<p>Спасибо за прохождение опроса!</p>';
  var stepCount = $('.quiz-step').length;
  var stepNext = stepCount + 1;
  var prevStep = stepCount - 1;
  var stepDiscount = Math.ceil(totaDiscount / prevStep);
  var progressLine = 100 / stepCount;
  var progressLineSum = 0;
  var discountSum = 0;
  var autoOpenTime = 100000005000;
  $('.receive__open').click(function () {
    $(this).toggleClass('receive__open_active');
    $('.receive').toggleClass('receive_opened');
  });
  $('.first-step__inner-bottom').clone().appendTo('.quiz-start .quiz-content__left');
  var autoOpen = true;
  setTimeout(function () {
    if (autoOpen) openQuiz();
  }, autoOpenTime);

  function openQuiz() {
    autoOpen = false;
    $('body').addClass('q-hidden');
    $('.quiz-modal').addClass('quiz-modal_opened');
    var quizHeight = $('.quiz-body').innerHeight();
    $('.quiz-wrapper').css('min-height', quizHeight);
  }

  $('.quiz-manager__inner').clone().appendTo('.quiz-mobile-info__manager');
  $('.quiz-mobile-info__btn').click(function () {
    $(this).toggleClass('quiz-mobile-info__btn_active');
    $(this).closest('.quiz-mobile-info').toggleClass('active');
  });
  $('.open-quiz').click(function (e) {
    e.preventDefault();
    openQuiz();
  });
  $('.quiz__close').click(function () {
    $('.quiz-modal').removeClass('quiz-modal_opened');
    $('body').removeClass('q-hidden');
  });
  $('.quiz-progress-mobile__count').text('0' + stepCount);

  for (var i = 1; i < stepCount + 1; i++) {
    $('.quiz-left_main .quiz-left-progress').append("<div class=\"quiz-left-progress__item progress-step progress-step_disable\"  data-progress=\"".concat(i, "\"><div class=\"quiz-left-progress__number\">").concat('0' + i, "</div><div class=\"quiz-left-progress__line\"></div></div>"));
  }

  $('.quiz-left_main .quiz-left-progress__item:first-child').addClass('quiz-left-progress__item_active').removeClass('progress-step_disable');
  $('.quiz-left_main .quiz-left-progress__item:nth-child(2)').removeClass('progress-step_disable');
  $('.quiz-input').each(function () {
    var txt = $(this).closest('label').text();
    $(this).attr('value', txt);
  });
  $('.quiz-body .quiz-content').each(function () {
    var inputCheckbox = $(this).find('input[type="checkbox"]').length;
    var quizElement = $(this).closest('.quiz-step');
    var quizStepNumber = quizElement.data('step');
    var quizTitle = quizElement.find('.quiz-title').text();
    quizElement.attr('data-discount', stepDiscount);
    $('.quiz-form').append('<input type="hidden" id="input' + quizStepNumber + '" name="' + quizTitle + '" value="Не имеет значения">');
    $('#input' + stepCount).attr('name', 'Мессенджер');

    if (inputCheckbox > 1) {
      $(this).find('.quiz-left__several').addClass('quiz-left__several_active');
    }

    if (quizElement.hasClass('required')) {
      quizElement.find('.quiz-controls__next').addClass('cursor-not-allowed');
      quizElement.find('.quiz-item__tags').append('<div class="quiz-item__plenty">Можно выбрать несколько</div>');
      $('.quiz-item__miss');
    }
  });
  $('.quiz-input').change(function () {
    var quizElement = $('.quiz-step_active');

    if (quizElement.hasClass('required')) {
      if (quizElement.find('.quiz-input:checked').length >= 1 && quizElement.hasClass('required')) {
        quizElement.find('.cursor-not-allowed').removeClass('cursor-not-allowed');
        $('.quiz-item__progress_mobile .quiz-controls__next').removeClass('cursor-not-allowed');
      } else {
        quizElement.find('.quiz-controls__next').addClass('cursor-not-allowed');
        $('.quiz-item__progress_mobile .quiz-controls__next').addClass('cursor-not-allowed');
      }
    }
  });
  $('.quiz-option-item__enter-input').on('input', function () {
    $(this).closest('.quiz-option-item').find('.quiz-input').val($(this).val()).prop('checked', true);

    if ($(this).val() === '') {
      $(this).closest('.quiz-option-item').find('.quiz-input').prop('checked', false);
    }
  });
  $('.quiz-input, .quiz-option-item__enter-input').on('change', function () {
    var quizElement = $(this).closest('.quiz-step');
    var quizStepNumber = quizElement.data('step');
    var quizInput = quizElement.find('.quiz-input');
    var inputValue = [];
    quizInput.filter(':checked').each(function () {
      inputValue.push(this.value);
    });
    $('#input' + quizStepNumber).attr('value', inputValue.join(','));
  });
  $('.first-step__btn').click(function (e) {
    $('.quiz-body').addClass('quiz-body_active');
    $('.quiz-start').addClass('quiz-start_disabled');
    progressLineSum += progressLine;
    $('.quiz-progress span').css('width', progressLineSum + '%');
    var asideText = $('.quiz-step[data-step=1]').find('.quiz-hidden-txt p');
    asideText.clone().appendTo('.quiz-aside-desc');
  });

  function progressSwitch(nextStep) {
    $('.quiz-left_main .quiz-left-progress__item').removeClass('quiz-left-progress__item_active');
    $('.quiz-left_main .quiz-left-progress__item[data-progress="' + nextStep + '"]').addClass('quiz-left-progress__item_active').addClass('quiz-left-progress__item_fill');
    $('.quiz-left_main .quiz-left-progress__item[data-progress="' + nextStep + '"]').next().removeClass('progress-step_disable');
    $('.quiz-left_main .quiz-left-progress__item[data-progress="' + nextStep + '"]').prev().addClass('quiz-left-progress__item_fill');
  }

  function lastStep() {
    if ($('#step' + stepCount).hasClass('quiz-step_active')) {
      $('.quiz-body').find('.receive-card').removeClass('receive-card__lock');
      $('.quiz-discount__value-plus').addClass('quiz-discount__value-plus_hidden');
      $('.quiz-aside-desc').html(asideDescLast);
      $('.quiz-item__progress').addClass('quiz-item__progress_hidden');
      $('.receive-title').text('За вами закреплены следующие  бонусы:');
      var receive = $('.quiz-aside .receive');
    }
  }

  function pricePlus(thisStep) {
    discountSum = stepDiscount * thisStep;

    if (discountSum > totaDiscount) {
      discountSum = totaDiscount;
    }

    $('.quiz-discount__value-txt > span').text(discountSum.toLocaleString());
  }

  function priceMinus(thisStep) {
    thisStep -= 1;
    discountSum = stepDiscount * thisStep;

    if (discountSum > totaDiscount) {
      discountSum = totaDiscount;
    }

    $('.quiz-discount__value-txt > span').text(discountSum.toLocaleString());
  }

  $('.quiz-controls__next').click(function () {
    var stepItem = $('.quiz-step');
    var stepItemActive = $('.quiz-step_active');
    var nextStep = stepItemActive.next();
    var nextStepNumber = nextStep.data('step');
    var currentStepNumber = stepItemActive.data('step');
    var checkedCount = stepItemActive.find('.quiz-input:checked').length;

    if (stepItemActive.hasClass('required') && checkedCount < 1) {
      return false;
    } else {
      progressLineSum += progressLine;
      $('.quiz-progress span').css('width', progressLineSum + '%');
      pricePlus(currentStepNumber);
      stepItem.removeClass('quiz-step_active');
      nextStep.addClass('quiz-step_active');
      progressSwitch(nextStepNumber);
      var asideText = nextStep.find('.quiz-hidden-txt p');
      $('.quiz-aside-desc').empty();
      asideText.clone().appendTo('.quiz-aside-desc');
      $('.quiz-progress-mobile__active').text('0' + nextStepNumber);

      if (nextStep.hasClass('required')) {
        $('.quiz-item__progress_mobile .quiz-controls__next').addClass('cursor-not-allowed');
      }
    }

    lastStep();
  });
  $('.quiz-controls__prev').click(function () {
    var stepItem = $('.quiz-step');
    var stepItemActive = $('.quiz-step_active');
    var prevStep = stepItemActive.prev();
    var prevStepNumber = prevStep.data('step');
    var checkedCount = stepItemActive.find('.quiz-input:checked').length;

    if (stepItemActive.is('#step1')) {
      $('.quiz-start').removeClass('quiz-start_disabled');
      setTimeout(function () {
        return $('.quiz-body').removeClass('quiz-body_active');
      }, 0);
    } else {
      progressLineSum -= progressLine;
      $('.quiz-progress span').css('width', progressLineSum + '%');
      priceMinus(prevStepNumber);
      stepItem.removeClass('quiz-step_active');
      prevStep.addClass('quiz-step_active');
      $('.quiz-left_main .quiz-left-progress__item').removeClass('quiz-left-progress__item_active');
      $('.quiz-left_main .quiz-left-progress__item[data-progress="' + prevStepNumber + '"]').addClass('quiz-left-progress__item_active');
      var asideText = prevStep.find('.quiz-hidden-txt p');
      $('.quiz-aside-desc').empty();
      asideText.clone().appendTo('.quiz-aside-desc');
      $('.quiz-progress-mobile__active').text('0' + prevStepNumber);
      $('.quiz-item__progress_mobile .quiz-controls__next').removeClass('cursor-not-allowed');
    }
  });
  $('body').on('click touchstart', '.progress-step', function () {
    var quizElement = $(this).closest('.quiz-step');
    var progressStep = quizElement.find('.quiz-left-progress__item');
    var thisStep = quizElement.data('step');
    var nextStep = +thisStep + 1;
    var prevStep = +thisStep - 1;
    var checkedCount = quizElement.find('.quiz-input:checked').length;
    var discountValue = +quizElement.data('discount');
    var stepProgress = $(this).attr('data-progress');
    var ff = +stepProgress + 1;
    var rr = +stepProgress - 1;

    if (quizElement.hasClass('required') && checkedCount < 1) {
      if (stepProgress > thisStep) {
        return false;
      } else {
        quizElement.removeClass('quiz-step_active');
        $('#step' + stepProgress).addClass('quiz-step_active');
        $('.quiz-left_main .quiz-left-progress__item').removeClass('quiz-left-progress__item_active');
        $('.quiz-left_main .quiz-left-progress__item[data-progress="' + stepProgress + '"]').addClass('quiz-left-progress__item_active').addClass('quiz-left-progress__item_fill').removeClass('progress-step_disable');
        $('.quiz-left_main .quiz-left-progress__item[data-progress="' + stepProgress + '"]').next().removeClass('progress-step_disable');
        $('.quiz-left_main .quiz-left-progress__item[data-progress="' + stepProgress + '"]').prev().addClass('quiz-left-progress__item_fill');
        var asideText = $('#step' + stepProgress).find('.quiz-hidden-txt p');
        $('.quiz-aside-desc').empty();
        asideText.clone().appendTo('.quiz-aside-desc');
      }
    } else {
      if ($(this).hasClass('progress-step_disable')) {
        return false;
      } else {
        if (stepProgress > ff) {
          priceMinus(rr);
        } else {
          pricePlus(rr);
        }

        var _asideText = $('#step' + stepProgress).find('.quiz-hidden-txt p');

        $('.quiz-aside-desc').empty();

        _asideText.clone().appendTo('.quiz-aside-desc');

        quizElement.removeClass('quiz-step_active');
        $('#step' + stepProgress).addClass('quiz-step_active');
        $('.quiz-left_main .quiz-left-progress__item').removeClass('quiz-left-progress__item_active');
        $('.quiz-left_main .quiz-left-progress__item[data-progress="' + stepProgress + '"]').addClass('quiz-left-progress__item_active').addClass('quiz-left-progress__item_fill').removeClass('progress-step_disable');
        $('.quiz-left_main .quiz-left-progress__item[data-progress="' + stepProgress + '"]').next().removeClass('progress-step_disable');
        $('.quiz-left_main .quiz-left-progress__item[data-progress="' + stepProgress + '"]').prev().addClass('quiz-left-progress__item_fill');
      }
    }

    lastStep();
  });
  $('.quiz-form').submit(function (e) {
    e.stopPropagation();
    e.preventDefault();
    var form = $(this);
    var field = [];
    var pattern = /(?:\+|\d)[\d\-\(\) ]{9,}\d/g;
    form.find('input[data-validate]').each(function () {
      if ($(this).val() != '') {
        $(this).closest('label').addClass('quiz-form__group_ok').removeClass('quiz-form__group_error');
        $.ajax({
          type: "POST",
          url: "form.php",
          data: form.serialize(),
          success: function success(data) {
            e.preventDefault();
          }
        }).done(function () {
          yaCounter67549219.reachGoal('quiz _finish'); gtag('event', 'quiz', { 'event_category': 'quiz', 'event_action': 'finish' }); gtag('event', 'page_view', { 'page_path': '/quiz-finish' });
          $('.quiz-body').removeClass('quiz-body_active');
          $('.quiz-end').addClass('quiz-end_active');
          $('.quiz__close').addClass('quiz__close_last');
        });
      } else {
        $(this).closest('label').addClass('quiz-form__group_error').removeClass('quiz-form__group_ok');
        e.preventDefault();
      }
    });
  });
  $('.button-tg').click(function (e) {
    e.preventDefault();
    $('.button-wa').removeClass('button-wa_selected');
    $('.button-vb').removeClass('button-vb_selected');
    $(this).toggleClass('button-tg_selected');
    $('input[name="Мессенджер"]').val($(this).val());
    $('.quiz-finish-messenger__item').removeClass('quiz-finish-messenger__item_active');
    $('#tg').addClass('quiz-finish-messenger__item_active');
    $('.quiz-finish-tabs').addClass('quiz-finish-tabs_active');
    $('.quiz-social').addClass('quiz-social_hidden');
    $('.quiz-finish__back').addClass('quiz-finish__back_active');
  });
  $('.button-wa').click(function (e) {
    e.preventDefault();
    $('.button-vb').removeClass('button-vb_selected');
    $('.button-tg').removeClass('button-tg_selected');
    $(this).toggleClass('button-wa_selected');
    $('input[name="Мессенджер"]').val($(this).val());
    $('.quiz-finish-messenger__item').removeClass('quiz-finish-messenger__item_active');
    $('#wa').addClass('quiz-finish-messenger__item_active');
    $('.quiz-social').addClass('quiz-social_hidden');
    $('.quiz-finish__back').addClass('quiz-finish__back_active');
  });
  $('.button-vb').click(function (e) {
    e.preventDefault();
    $('.button-wa').removeClass('button-wa_selected');
    $('.button-tg').removeClass('button-tg_selected');
    $(this).toggleClass('button-vb_selected');
    $('input[name="Мессенджер"]').val($(this).val());
    $('.quiz-finish-messenger__item').removeClass('quiz-finish-messenger__item_active');
    $('#vb').addClass('quiz-finish-messenger__item_active');
    $('.quiz-social').addClass('quiz-social_hidden');
    $('.quiz-finish__back').addClass('quiz-finish__back_active');
  });
  $('.quiz-finish__back').click(function () {
    $(this).removeClass('quiz-finish__back_active');
    $('.quiz-finish-messenger__item').removeClass('quiz-finish-messenger__item_active');
    $('.quiz-social').removeClass('quiz-social_hidden');
    $('.quiz-finish-tabs').removeClass('quiz-finish-tabs_active'); // $('#f-login').find('input').removeAttr('data-validate')
    // $('#f-phone').find('input').attr('data-phone', '')

    $('#f-phone').removeClass('quiz-form__group_hidden');
    $('#f-login').addClass('quiz-form__group_hidden');
    $('.button-wa').removeClass('button-wa_selected');
    $('.button-vb').removeClass('button-vb_selected');
    $('.button-tg').removeClass('button-tg_selected');
    $('input[name="Мессенджер"]').val('Не имеет значения');
  });
  $('.quiz-finish-tabs__item').click(function () {
    $('.quiz-finish-tabs__item').removeClass('quiz-finish-tabs__item_selected');
    $(this).addClass('quiz-finish-tabs__item_selected');
    var type = $(this).data('type');

    if (type === 'login') {
      $('#f-phone').addClass('quiz-form__group_hidden');
      $('#f-login').removeClass('quiz-form__group_hidden');
      $('#f-login').find('input').attr('data-validate', '');
      $('#f-phone').find('input').removeAttr('data-validate');
    } else {
      $('#f-phone').removeClass('quiz-form__group_hidden');
      $('#f-login').addClass('quiz-form__group_hidden');
      $('#f-login').find('input').removeAttr('data-validate');
      $('#f-phone').find('input').attr('data-validate', '');
    }
  });
  $('.quiz-images-label').click(function () {
    $(this).closest('.quiz-images').find('.quiz-images-label').removeClass('quiz-images-label_selected');
    $(this).addClass('quiz-images-label_selected');
  });
  $('.quiz-option-item__checked_enter').click(function () {
    $(this).parent().find('.quiz-option-item__enter-input').focus();
  });
  $('.quiz-option-item__enter-input').on('input', function () {
    var charCount = $(this).val().length;
    console.log(charCount);
    $('.quiz-option-item__enter-count span').text(charCount);
  });
  $(".quiz-form__input").focusin(function () {
    $(this).closest('.quiz-form__group').addClass('quiz-form__group_active');
  });
  $(".quiz-form__input").focusout(function () {
    $(this).parent().addClass('quiz-form__group_active');

    if ($(this).val() == "") {
      $(this).parent().removeClass('quiz-form__group_active');
    }
  });
  $('input.quiz-form__input[type="phone"]').mask('+7(999)999-99-99'); // $('input.quiz-form__input[type="phone"]').on('keyup', function (event) {
  // 	let numb = $(this).val();
  // 	let phone = '';
  // 	if (numb[3] == '8') {
  // 		phone = '+7';
  // 		$(this).val(phone);
  // 	}
  // });

  $('input.quiz-form__input[type="phone"]').on('input blur', function () {
    if ($(this).val() != '') {
      var pattern = /[+]7[(][0-9]{3}[)][0-9]{3}[-][0-9]{2}[-][0-9]{2}/g;

      if (pattern.test($(this).val())) {
        $(this).closest('label').addClass('quiz-form__group_ok').removeClass('quiz-form__group_error');
      } else {
        $(this).closest('label').addClass('quiz-form__group_error').removeClass('quiz-form__group_ok');
      }
    } else {
      $(this).closest('label').removeClass('quiz-form__group_error').removeClass('quiz-form__group_ok');
    }
  });
  $(function () {
    var min = 2;
    var max = 12;
    $(".slider-range").slider({
      range: true,
      min: min,
      max: max,
      values: [2, 8],
      slide: function slide(event, ui) {
        $(".input-from").val(ui.values[0]);
        $(".input-to").val(ui.values[1]);
        $(".span-from").text(ui.values[0]);
        $(".span-to").text(ui.values[1]);
        var step = $(this).closest('.quiz-step').attr('data-step');
        $('#input' + step).val('От ' + (+$(".slider-range").slider("values", 0) - 1) + ' До ' + (+$(".slider-range").slider("values", 1) + 1));
      }
    });
    $('.slider-range > span:nth-of-type(1)').addClass('span-from');
    $('.slider-range > span:nth-of-type(2)').addClass('span-to');
    $(".input-from").val($(".slider-range").slider("values", 0));
    $(".input-to").val($(".slider-range").slider("values", 1));
    $(".span-from").text($(".slider-range").slider("values", 0));
    $(".span-to").text($(".slider-range").slider("values", 1));
    $('.input-from, .input-to, input[type="phone"]').keypress(function (e) {
      if (e.which != 8 && e.which != 0 && e.which != 46 && (e.which < 48 || e.which > 57)) {
        return false;
      }
    });
    $('.input-from').on('change input', function () {
      $(".slider-range").slider('values', 0, $(this).val());
      var maxVal = $(".slider-range").slider("values", 1);
      var sum = $(this).val();
      $(".span-from").text(sum);

      if (sum < 1 && sum <= maxVal) {
        sum = 1;
        $(this).val(sum);
        $(".span-from").text(sum);
        $(".slider-range").slider('values', 0, $(this).val());
      } else if (sum > maxVal) {
        sum = maxVal;
        $(this).val(sum);
        $(".span-from").text(sum);
        $(".slider-range").slider('values', 0, $(this).val());
      }
    });
    var input = $('.input-to'),
        timeOut;
    input.on('keyup', function () {
      clearTimeout(timeOut);
      timeOut = setTimeout(myfunc, 2000, $(this).val());
    });
    input.on('keydown', function () {
      clearTimeout(timeOut);
    });

    function myfunc(value) {
      console.log(value);
      var minVal = $(".slider-range").slider("values", 0);
      var sum = value;

      if (sum > max) {
        sum = max;
        $('.input-to').val(sum);
        $(".span-to").text(sum);
        $(".slider-range").slider('values', 1, value);
      } else if (sum < minVal) {
        $('.input-to').val(minVal);
        $(".span-to").text(minVal);
        $(".slider-range").slider('values', 1, minVal);
      } else {
        $(".slider-range").slider('values', 1, value);
        $(".span-to").text(sum);
      }
    }

    $('.floor-max').change(function () {
      if ($(this).prop("checked") && $('.span-to').text() == max) {
        $(".span-to").text(max - 1);
        $(".input-to").val(max - 1);
        var maxSlide = max - 1;
        $(".slider-range").slider('values', 1, maxSlide);
      }
    });
    $('.floor-min').change(function () {
      if ($(this).prop("checked") && $('.span-from').text() == '1') {
        $(".span-from").text(min + 1);
        $(".input-from").val(min + 1);
        var minSlide = min + 1;
        $(".slider-range").slider('values', 0, minSlide);
      }
    });
  });
  $(window).on('load resize', function () {
    var quizHeight = $('.quiz-body').innerHeight();
    $('.quiz-wrapper').css('min-height', quizHeight);
  });
  $(document).mouseup(function (e) {
    var modalquiz = $(".quiz");

    if (!modalquiz.is(e.target) && modalquiz.has(e.target).length === 0) {
      $('.quiz-modal').removeClass('quiz-modal_opened');
      $('body').removeClass('q-hidden');
    }
  });
});